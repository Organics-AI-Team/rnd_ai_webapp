version: '3.8'

# R&D AI Management - Docker Compose Configuration
# This file allows you to run both web and AI services together locally

services:
  # Web Frontend Application
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
    container_name: rnd-ai-web
    ports:
      - "3000:3000"
    environment:
      # Database
      - MONGODB_URI=${MONGODB_URI}
      - RAW_MATERIALS_REAL_STOCK_MONGODB_URI=${RAW_MATERIALS_REAL_STOCK_MONGODB_URI}

      # AI Service URL (connects to ai service container)
      - AI_SERVICE_URL=http://ai:3001

      # API Keys
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - PINECONE_API_KEY=${PINECONE_API_KEY}

      # Public Variables
      - NEXT_PUBLIC_GEMINI_API_KEY=${NEXT_PUBLIC_GEMINI_API_KEY}
      - NEXT_PUBLIC_OPENAI_API_KEY=${NEXT_PUBLIC_OPENAI_API_KEY}
      - NEXT_PUBLIC_API_URL=http://localhost:3000/api

      # Admin
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}

      # Node Environment
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1

    depends_on:
      - ai
      - chromadb

    networks:
      - rnd-ai-network

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # AI Backend Service
  ai:
    build:
      context: .
      dockerfile: Dockerfile.ai
    container_name: rnd-ai-service
    ports:
      - "3001:3001"
    environment:
      # Database
      - MONGODB_URI=${MONGODB_URI}
      - RAW_MATERIALS_REAL_STOCK_MONGODB_URI=${RAW_MATERIALS_REAL_STOCK_MONGODB_URI}

      # AI APIs
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - PINECONE_API_KEY=${PINECONE_API_KEY}

      # Vector Database
      - VECTOR_DB_PROVIDER=chroma
      - CHROMA_URL=http://chromadb:8000

      # Service Configuration
      - AI_SERVICE_PORT=3001
      - WEB_APP_URL=http://web:3000

      # Node Environment
      - NODE_ENV=production

    depends_on:
      - chromadb

    networks:
      - rnd-ai-network

    volumes:
      # Persist ChromaDB data
      - chromadb-data:/app/apps/ai/.chromadb

    restart: unless-stopped

  # ChromaDB Vector Database
  chromadb:
    image: chromadb/chroma:latest
    container_name: rnd-ai-chromadb
    ports:
      - "8000:8000"
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=FALSE

    volumes:
      - chromadb-data:/chroma/chroma

    networks:
      - rnd-ai-network

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/heartbeat"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

networks:
  rnd-ai-network:
    driver: bridge
    name: rnd-ai-network

volumes:
  chromadb-data:
    driver: local
    name: rnd-ai-chromadb-data

# Usage:
# ------
# 1. Copy .env.example to .env and fill in your values
# 2. Build and start all services:
#    docker-compose up -d
#
# 3. View logs:
#    docker-compose logs -f web
#    docker-compose logs -f ai
#    docker-compose logs -f chromadb
#
# 4. Stop all services:
#    docker-compose down
#
# 5. Stop and remove volumes:
#    docker-compose down -v
#
# 6. Rebuild after code changes:
#    docker-compose up -d --build
#
# Access:
# -------
# Web App: http://localhost:3000
# AI Service: http://localhost:3001
# ChromaDB: http://localhost:8000
